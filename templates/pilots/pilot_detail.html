{% extends 'base.html' %}
{% load pilot_tags %}

{% block title %}{{ pilot.title }} - Fend{% endblock %}

{% block content %}
<div class="py-6">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Main Content Grid: Info + Action Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- LEFT: Pilot Information (2/3 width) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Pilot Header -->
                <div class="bg-white shadow sm:rounded-lg">
                    <div class="px-6 py-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">{{ pilot.title }}</h1>
                                <div class="mt-2 flex items-center space-x-4 text-sm text-gray-600">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                        </svg>
                                        {{ pilot.organization.name }}
                                    </span>
                                    <span>•</span>
                                    <span>{{ pilot.created_at|date:"M j, Y" }}</span>
                                    {% if pilot.is_private %}
                                        <span>•</span>
                                        <span class="text-orange-600 font-medium">Private</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-gray-900 mb-2">
                                    {% if pilot.price > 0 %}
                                        ${{ pilot.price|floatformat:0 }}
                                    {% else %}
                                        <span class="text-green-600">Free</span>
                                    {% endif %}
                                </div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                    {% if pilot.status == 'published' %}bg-green-100 text-green-800
                                    {% elif pilot.status == 'draft' %}bg-gray-100 text-gray-800
                                    {% elif pilot.status == 'pending_approval' %}bg-yellow-100 text-yellow-800
                                    {% elif pilot.status == 'in_progress' %}bg-blue-100 text-blue-800
                                    {% elif pilot.status == 'completed' %}bg-purple-100 text-purple-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if pilot.status == 'pending_approval' %}
                                        Pending Approval
                                    {% elif pilot.status == 'in_progress' %}
                                        In Progress
                                    {% else %}
                                        {{ pilot.status|title }}
                                    {% endif %}
                                </span>
                                
                                <!-- Status Progress Indicator -->
                                {% if user.organization == pilot.organization %}
                                <div class="mt-3">
                                    <div class="flex items-center text-xs text-gray-600">
                                        <div class="flex items-center space-x-2">
                                            <!-- Draft -->
                                            <div class="flex items-center {% if pilot.status == 'draft' %}text-indigo-600{% else %}text-gray-400{% endif %}">
                                                <div class="w-2 h-2 rounded-full {% if pilot.status == 'draft' %}bg-indigo-600{% else %}bg-gray-300{% endif %} mr-1"></div>
                                                <span>Draft</span>
                                            </div>
                                            <svg class="w-3 h-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                            <!-- Review -->
                                            <div class="flex items-center {% if pilot.status == 'pending_approval' %}text-yellow-600{% elif pilot.status in 'published,in_progress,completed' %}text-green-600{% else %}text-gray-400{% endif %}">
                                                <div class="w-2 h-2 rounded-full {% if pilot.status == 'pending_approval' %}bg-yellow-500{% elif pilot.status in 'published,in_progress,completed' %}bg-green-500{% else %}bg-gray-300{% endif %} mr-1"></div>
                                                <span>Review</span>
                                            </div>
                                            <svg class="w-3 h-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                            <!-- Live -->
                                            <div class="flex items-center {% if pilot.status in 'published,in_progress,completed' %}text-green-600{% else %}text-gray-400{% endif %}">
                                                <div class="w-2 h-2 rounded-full {% if pilot.status in 'published,in_progress,completed' %}bg-green-500{% else %}bg-gray-300{% endif %} mr-1"></div>
                                                <span>Live</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="prose max-w-none">
                            <p class="text-gray-700 text-lg leading-relaxed">{{ pilot.description }}</p>
                        </div>
                    </div>
                </div>

                <!-- Status Explanation & Next Steps -->
                {% if user.organization == pilot.organization %}
                <div class="bg-white shadow sm:rounded-lg">
                    <div class="px-6 py-6">
                        {% if pilot.status == 'draft' %}
                        <div class="rounded-lg bg-blue-50 border border-blue-200 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-blue-900 mb-2">Your pilot is in draft mode</h3>
                                    <p class="text-blue-800 mb-4">Complete your pilot details and submit for review to start receiving proposals from startups.</p>
                                    <div class="space-y-2 text-sm text-blue-700">
                                        <p><strong>What happens next:</strong></p>
                                        <ol class="list-decimal list-inside space-y-1 ml-4">
                                            <li>Complete all required sections (technical specs, performance metrics, compliance requirements)</li>
                                            <li>Submit for review - your pilot will move to "Pending Approval" status</li>
                                            <li>Our team reviews and approves your pilot (usually within 24 hours)</li>
                                            <li>Once approved, your pilot goes live and startups can submit proposals</li>
                                        </ol>
                                    </div>
                                    <div class="mt-4 flex space-x-3">
                                        <a href="{% url 'pilots:edit' pilot.id %}" 
                                           class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 shadow-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                            Continue Editing
                                        </a>
                                        {% if pilot.can_be_published %}
                                        <div class="mt-4 p-3 bg-gray-50 rounded-lg border">
                                            <div class="flex items-start">
                                                <input type="checkbox" id="legal_agreement_checkbox" 
                                                       class="mt-1 h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                                <div class="ml-3 text-sm">
                                                    <label for="legal_agreement_checkbox" class="font-medium text-gray-700">
                                                        I accept the legal agreement and payment terms
                                                    </label>
                                                    <p class="text-gray-500 text-xs mt-1">
                                                        Required to submit pilot for review and publish to the marketplace
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" onclick="submitForReview()" 
                                                class="mt-3 inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 shadow-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                            </svg>
                                            Submit for Review
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% elif pilot.status == 'pending_approval' %}
                        <div class="rounded-lg bg-yellow-50 border border-yellow-200 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-yellow-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-yellow-900 mb-2">Under Review</h3>
                                    <p class="text-yellow-800 mb-4">Your pilot has been submitted for review. Our team is currently evaluating it for compliance and completeness.</p>
                                    <div class="space-y-2 text-sm text-yellow-700">
                                        <p><strong>What happens next:</strong></p>
                                        <ol class="list-decimal list-inside space-y-1 ml-4">
                                            <li>Our team reviews your pilot (usually within 24 hours)</li>
                                            <li>If approved, your pilot will go live automatically</li>
                                            <li>If changes are needed, we'll contact you with specific feedback</li>
                                            <li>Once live, you'll start receiving proposals from qualified startups</li>
                                        </ol>
                                    </div>
                                    <div class="mt-4">
                                        <span class="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-medium rounded-full">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Average review time: 24 hours
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% elif pilot.status == 'published' %}
                        <div class="rounded-lg bg-green-50 border border-green-200 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-green-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-green-900 mb-2">Your pilot is live!</h3>
                                    <p class="text-green-800 mb-4">Congratulations! Your pilot has been approved and is now visible to qualified startups. They can submit proposals starting now.</p>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <p><strong>What happens next:</strong></p>
                                        <ol class="list-decimal list-inside space-y-1 ml-4">
                                            <li>Startups will submit proposals for your pilot project</li>
                                            <li>Review proposals and select the best fit for your needs</li>
                                            <li>Once you approve a proposal, the pilot moves to "In Progress"</li>
                                            <li>Work with your selected startup through secure milestone tracking</li>
                                        </ol>
                                    </div>
                                    <div class="mt-4">
                                        <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                            Visible to {{ pilot.get_bid_count }} startups so far
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% elif pilot.status == 'in_progress' %}
                        <div class="rounded-lg bg-blue-50 border border-blue-200 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-blue-900 mb-2">Pilot in progress</h3>
                                    <p class="text-blue-800 mb-4">Great! You've selected a startup partner and your pilot project is now underway.</p>
                                    <div class="space-y-2 text-sm text-blue-700">
                                        <p><strong>Active collaboration:</strong></p>
                                        <ul class="list-disc list-inside space-y-1 ml-4">
                                            <li>Monitor progress through milestone tracking</li>
                                            <li>Communicate directly with your startup partner</li>
                                            <li>Payments are held securely by our Payment Holding Service until completion</li>
                                            <li>Review and approve completed deliverables</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% elif pilot.status == 'completed' %}
                        <div class="rounded-lg bg-purple-50 border border-purple-200 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-purple-900 mb-2">Pilot completed successfully</h3>
                                    <p class="text-purple-800 mb-4">Congratulations! Your pilot project has been completed successfully. Payment has been released to your startup partner.</p>
                                    <div class="space-y-2 text-sm text-purple-700">
                                        <p><strong>What's next:</strong></p>
                                        <ul class="list-disc list-inside space-y-1 ml-4">
                                            <li>Consider expanding your successful pilot to a full deployment</li>
                                            <li>Create new pilots to explore additional innovation opportunities</li>
                                            <li>Build ongoing partnerships with proven startup collaborators</li>
                                        </ul>
                                    </div>
                                    <div class="mt-4">
                                        <a href="{% url 'pilots:create' %}" 
                                           class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 shadow-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                            Create Another Pilot
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- JavaScript for Submit for Review -->
                <script>
                function submitForReview() {
                    // Check if legal agreement is accepted
                    const legalCheckbox = document.getElementById('legal_agreement_checkbox');
                    if (!legalCheckbox || !legalCheckbox.checked) {
                        alert('Please accept the legal agreement and payment terms before submitting your pilot for review.');
                        return;
                    }
                    
                    if (confirm('Ready to submit your pilot for review?\n\nOnce submitted:\n• Our team will review it within 24 hours\n• If approved, it will go live automatically\n• You\'ll be notified of any required changes\n\nProceed with submission?')) {
                        // Create a form to submit the publish request
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = '{% url "pilots:publish" pilot.id %}';
                        
                        // Add CSRF token
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);
                        
                        // Add legal agreement acceptance
                        const legalInput = document.createElement('input');
                        legalInput.type = 'hidden';
                        legalInput.name = 'legal_agreement_accepted';
                        legalInput.value = 'on';
                        form.appendChild(legalInput);
                        
                        document.body.appendChild(form);
                        form.submit();
                    }
                }
                </script>

                <!-- Pilot Requirements & Specs -->
                <div class="bg-white shadow sm:rounded-lg">
                    <div class="px-6 py-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Requirements & Specifications</h2>
                        
                        <div class="space-y-6">
                            <!-- Technical Specifications -->
                            {% if pilot.technical_specs_doc or pilot.technical_specs_text %}
                            <div>
                                <h3 class="text-lg font-medium text-gray-900 mb-3">Technical Specifications</h3>
                                {% if pilot.technical_specs_doc %}
                                    <div class="flex items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <svg class="w-8 h-8 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <p class="font-medium text-blue-900">Technical Specifications Document</p>
                                            <p class="text-sm text-blue-700">Detailed technical requirements and specifications</p>
                                        </div>
                                        <div class="ml-4 flex items-center gap-2">
                                            <a href="{{ pilot.technical_specs_doc.url }}" 
                                               target="_blank"
                                               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700"
                                               onclick="handleFileAccess(event, this, 'technical-{{ pilot.id }}')">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                Download
                                            </a>
                                            <a href="{% url 'pilots:serve_pilot_file' pilot_id=pilot.id file_type='technical' %}"
                                               target="_blank"
                                               id="technical-{{ pilot.id }}"
                                               class="text-gray-500 hover:text-gray-700 text-sm hidden">
                                                (Alternative link)
                                            </a>
                                        </div>
                                    </div>
                                {% elif pilot.technical_specs_text %}
                                    <div class="bg-gray-50 rounded-lg p-4 border">
                                        <pre class="whitespace-pre-wrap text-sm text-gray-900 font-sans">{{ pilot.technical_specs_text }}</pre>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Performance Metrics -->
                            {% if pilot.performance_metrics or pilot.performance_metrics_doc %}
                            <div>
                                <h3 class="text-lg font-medium text-gray-900 mb-3">Performance Metrics</h3>
                                {% if pilot.performance_metrics_doc %}
                                    <div class="flex items-center p-4 bg-green-50 rounded-lg border border-green-200">
                                        <svg class="w-8 h-8 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <p class="font-medium text-green-900">Performance Metrics Document</p>
                                            <p class="text-sm text-green-700">Key performance indicators and success metrics</p>
                                        </div>
                                        <div class="ml-4 flex items-center gap-2">
                                            <a href="{{ pilot.performance_metrics_doc.url }}" 
                                               target="_blank"
                                               class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700"
                                               onclick="handleFileAccess(event, this, 'performance-{{ pilot.id }}')">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                Download
                                            </a>
                                            <a href="{% url 'pilots:serve_pilot_file' pilot_id=pilot.id file_type='performance' %}"
                                               target="_blank"
                                               id="performance-{{ pilot.id }}"
                                               class="text-gray-500 hover:text-gray-700 text-sm hidden">
                                                (Alternative link)
                                            </a>
                                        </div>
                                    </div>
                                {% elif pilot.performance_metrics %}
                                    <div class="bg-gray-50 rounded-lg p-4 border">
                                        <pre class="whitespace-pre-wrap text-sm text-gray-900 font-sans">{{ pilot.performance_metrics }}</pre>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Definition of Done -->
                            {% if pilot.compliance_requirements or pilot.compliance_requirements_doc %}
                            <div>
                                <h3 class="text-lg font-medium text-gray-900 mb-3">Definition of Done</h3>
                                {% if pilot.compliance_requirements_doc %}
                                    <div class="flex items-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                                        <svg class="w-8 h-8 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <p class="font-medium text-purple-900">Completion Requirements</p>
                                            <p class="text-sm text-purple-700">Success criteria and delivery requirements</p>
                                        </div>
                                        <div class="ml-4 flex items-center gap-2">
                                            <a href="{{ pilot.compliance_requirements_doc.url }}" 
                                               target="_blank"
                                               class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700"
                                               onclick="handleFileAccess(event, this, 'compliance-{{ pilot.id }}')">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                Download
                                            </a>
                                            <a href="{% url 'pilots:serve_pilot_file' pilot_id=pilot.id file_type='compliance' %}"
                                               target="_blank"
                                               id="compliance-{{ pilot.id }}"
                                               class="text-gray-500 hover:text-gray-700 text-sm hidden">
                                                (Alternative link)
                                            </a>
                                        </div>
                                    </div>
                                {% elif pilot.compliance_requirements %}
                                    <div class="bg-gray-50 rounded-lg p-4 border">
                                        <pre class="whitespace-pre-wrap text-sm text-gray-900 font-sans">{{ pilot.compliance_requirements }}</pre>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT: Action Panel (1/3 width) -->
            <div class="lg:col-span-1">
                <div class="sticky top-6">
                    
                    {% if is_owner and pilot.status == 'draft' %}
                        <!-- DRAFT: Ready to Publish -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-yellow-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-4">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-yellow-800">Draft Pilot</h3>
                                        <p class="text-sm text-yellow-700">Ready to publish?</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="bg-yellow-50 rounded-lg p-4">
                                        <p class="text-sm text-yellow-800">
                                            Publishing your pilot will make it visible to startups in our network. 
                                            Make sure all information is accurate and complete.
                                        </p>
                                    </div>
                                    
                                    <form method="post" action="{% url 'pilots:publish' pilot.pk %}">
                                        {% csrf_token %}
                                        <div class="space-y-4">
                                            <label class="flex items-start">
                                                <input type="checkbox" name="legal_agreement_accepted" required
                                                       class="mt-1 h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                                                <span class="ml-3 text-sm text-gray-700">
                                                    I confirm that all pilot information is accurate and I agree to the 
                                                    <a href="{% url 'legal_document' 'payment-terms' %}" target="_blank" class="text-yellow-600 hover:text-yellow-800 underline">Payment Terms</a> and 
                                                    <a href="{% url 'legal_document' 'payment-holding-agreement' %}" target="_blank" class="text-yellow-600 hover:text-yellow-800 underline">Payment Holding Agreement</a>.
                                                </span>
                                            </label>
                                            
                                            <button type="submit" 
                                                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                                                Submit for Review
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                    {% elif is_owner and pending_bids %}
                        <!-- ENTERPRISE: Pending Bids to Review -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-orange-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-6">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-orange-800">Pending Bids</h3>
                                        <p class="text-sm text-orange-700">{{ pending_bids.count }} startup{{ pending_bids.count|pluralize }} waiting for response</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    {% for bid in pending_bids %}
                                    <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <h4 class="font-medium text-orange-900">{{ bid.startup.name }}</h4>
                                            <span class="text-lg font-bold text-orange-900">${{ bid.amount|floatformat:0 }}</span>
                                        </div>
                                        <p class="text-sm text-orange-800 mb-3 line-clamp-2">{{ bid.proposal|truncatewords:15 }}</p>
                                        <div class="flex space-x-2">
                                            <a href="{% url 'pilots:bid_detail' bid.pk %}" 
                                               class="flex-1 text-center py-2 px-3 bg-orange-600 text-white text-sm font-medium rounded hover:bg-orange-700">
                                                Review Bid
                                            </a>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                    {% elif is_owner and approved_bids %}
                        <!-- ENTERPRISE: Active Work Management -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-green-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-6">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-green-800">Active Work</h3>
                                        <p class="text-sm text-green-700">{{ approved_bids.count }} startup{{ approved_bids.count|pluralize }} working on this pilot</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    {% for bid in approved_bids %}
                                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <h4 class="font-medium text-green-900">{{ bid.startup.name }}</h4>
                                            <span class="text-lg font-bold text-green-900">${{ bid.amount|floatformat:0 }}</span>
                                        </div>
                                        <div class="mb-3">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                {% if bid.status == 'live' %}bg-blue-100 text-blue-800
                                                {% elif bid.status == 'completion_pending' %}bg-yellow-100 text-yellow-800
                                                {% elif bid.status == 'completed' %}bg-green-100 text-green-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ bid.get_status_display }}
                                            </span>
                                        </div>
                                        <div class="flex space-x-2">
                                            {% if bid.status == 'completion_pending' %}
                                            <form method="post" action="{% url 'pilots:verify_completion' bid.pk %}" class="flex-1">
                                                {% csrf_token %}
                                                <button type="submit" 
                                                        class="w-full py-2 px-3 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700"
                                                        onclick="return confirm('Verify completion and release payment?');">
                                                    Verify & Pay
                                                </button>
                                            </form>
                                            {% else %}
                                            <a href="{% url 'pilots:bid_detail' bid.pk %}" 
                                               class="flex-1 text-center py-2 px-3 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700">
                                                Manage Work
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                    {% elif has_working_agreement %}
                        <!-- STARTUP: Active Work Status -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-blue-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-6">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2V6"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-blue-800">Your Work</h3>
                                        <p class="text-sm text-blue-700">Working with {{ pilot.organization.name }}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="bg-blue-50 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-blue-800">Status</span>
                                            <span class="text-sm font-medium text-blue-900">{{ relationship.bid.get_status_display }}</span>
                                        </div>
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-blue-800">Your Amount</span>
                                            <span class="text-lg font-bold text-blue-900">${{ working_agreement.amount|floatformat:0 }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-blue-800">Net Payment</span>
                                            <span class="text-sm font-medium text-blue-900">${{ working_agreement.calculate_startup_net_amount|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                    
                                    {% if can_request_completion %}
                                    <form method="post" action="{% url 'pilots:request_completion' relationship.bid.pk %}">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                class="w-full py-3 px-4 bg-green-600 text-white font-medium rounded-md hover:bg-green-700"
                                                onclick="return confirm('Mark work complete and request verification?');">
                                            Mark Work Complete
                                        </button>
                                    </form>
                                    {% else %}
                                    <a href="{% url 'pilots:bid_detail' relationship.bid.pk %}" 
                                       class="block w-full text-center py-3 px-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
                                        View Work Details
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                    {% elif is_bidder %}
                        <!-- STARTUP: Bid Status -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-yellow-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-6">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-yellow-800">Your Bid</h3>
                                        <p class="text-sm text-yellow-700">${{ relationship.bid.amount|floatformat:0 }} • {{ relationship.bid.get_status_display }}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    {% if relationship.bid_status == 'declined' and relationship.rejection_reason %}
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-red-800 mb-2">Feedback from {{ pilot.organization.name }}</h4>
                                        <p class="text-sm text-red-700">{{ relationship.rejection_reason }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="flex space-x-2">
                                        {% if can_edit_bid %}
                                        <a href="{% url 'pilots:create_bid' pilot.pk %}" 
                                           class="flex-1 text-center py-2 px-3 bg-yellow-600 text-white text-sm font-medium rounded hover:bg-yellow-700">
                                            Edit Bid
                                        </a>
                                        {% endif %}
                                        {% if can_resubmit_bid %}
                                        <a href="{% url 'pilots:create_bid' pilot.pk %}" 
                                           class="flex-1 text-center py-2 px-3 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700">
                                            New Bid
                                        </a>
                                        {% endif %}
                                    </div>
                                    
                                    <a href="{% url 'pilots:bid_detail' relationship.bid.pk %}" 
                                       class="block w-full text-center py-2 px-3 border border-gray-300 text-sm font-medium rounded text-gray-700 hover:bg-gray-50">
                                        View Bid Details
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                    {% elif relationship.type == 'available' and not can_bid %}
                        <!-- STARTUP: Pending Approval - Can't Bid Yet -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-yellow-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-4">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-yellow-800">Account Pending Approval</h3>
                                        <p class="text-sm text-yellow-700">You can browse opportunities, but need approval to submit bids</p>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 rounded-lg p-4">
                                    <p class="text-sm text-yellow-800">
                                        Your account is currently under review. Once approved, you'll be able to submit your proposal and bid amount to compete for this pilot project with {{ pilot.organization.name }}.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                    {% elif can_bid %}
                        <!-- STARTUP: Submit New Bid -->
                        <div class="bg-white shadow sm:rounded-lg border-l-4 border-indigo-400">
                            <div class="px-6 py-6">
                                <div class="flex items-center mb-6">
                                    <div class="flex-shrink-0">
                                        <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-medium text-indigo-800">Submit Bid</h3>
                                        <p class="text-sm text-indigo-700">Interested in this opportunity?</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="bg-indigo-50 rounded-lg p-4">
                                        <p class="text-sm text-indigo-800">
                                            Submit your proposal and bid amount to compete for this pilot project with {{ pilot.organization.name }}.
                                        </p>
                                    </div>
                                    
                                    <a href="{% url 'pilots:create_bid' pilot.pk %}" 
                                       class="block w-full text-center py-3 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">
                                        Submit Your Bid
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                    {% else %}
                        <!-- GENERAL: Information Only -->
                        <div class="bg-white shadow sm:rounded-lg">
                            <div class="px-6 py-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Pilot Information</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Status</span>
                                        <span class="font-medium">{{ pilot.get_status_display }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Budget</span>
                                        <span class="font-medium">
                                            {% if pilot.price > 0 %}${{ pilot.price|floatformat:0 }}{% else %}Free{% endif %}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Created</span>
                                        <span class="font-medium">{{ pilot.created_at|date:"M j, Y" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Navigation -->
                    <div class="mt-6 flex space-x-3">
                        <a href="{% url 'pilots:list' %}" 
                           class="flex-1 text-center py-2 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            ← Back to Pilots
                        </a>
                        {% if is_owner and can_edit %}
                        <a href="{% url 'pilots:edit' pilot.pk %}" 
                           class="flex-1 text-center py-2 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Edit
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

{% endblock %}