{% extends 'base.html' %}

{% block title %}Escrow Payment Details - Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Escrow Payment Details</h1>
                    <p class="mt-1 text-sm text-gray-500">Reference: {{ payment.reference_code }}</p>
                </div>
                <div class="flex space-x-4">
                    <a href="{% url 'payments:admin_escrow_payments' %}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Back to All Payments
                    </a>
                    <a href="{% url 'payments:admin_payment_dashboard' %}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <!-- Payment Summary Card -->
                <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-800">Payment Summary</h2>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full 
                                {% if payment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif payment.status == 'instructions_sent' %}bg-blue-100 text-blue-800
                                {% elif payment.status == 'payment_initiated' %}bg-indigo-100 text-indigo-800
                                {% elif payment.status == 'received' %}bg-green-100 text-green-800
                                {% elif payment.status == 'released' %}bg-purple-100 text-purple-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ payment.get_status_display }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Pilot</h3>
                                <p class="mt-1 text-lg font-medium text-gray-900">{{ payment.pilot_bid.pilot.title }}</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Reference Code</h3>
                                <p class="mt-1 text-lg font-mono text-indigo-600">{{ payment.reference_code }}</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Enterprise</h3>
                                <p class="mt-1 text-lg font-medium text-gray-900">{{ payment.pilot_bid.pilot.organization.name }}</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Startup</h3>
                                <p class="mt-1 text-lg font-medium text-gray-900">{{ payment.pilot_bid.startup.name }}</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Financial Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-500">Base Amount</p>
                                    <p class="text-2xl font-bold text-gray-900">${{ payment.startup_amount }}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-500">Platform Fee</p>
                                    <p class="text-2xl font-bold text-gray-900">${{ payment.platform_fee|floatformat:2 }}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        {{ payment.enterprise_fee_percentage }}% + {{ payment.startup_fee_percentage }}%
                                    </p>
                                </div>
                                <div class="bg-indigo-50 rounded-lg p-4">
                                    <p class="text-sm text-indigo-600">Total Amount</p>
                                    <p class="text-2xl font-bold text-indigo-600">${{ payment.total_amount }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Timeline -->
                <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <h2 class="text-xl font-bold text-gray-800">Status Timeline</h2>
                    </div>
                    
                    <div class="p-6">
                        <div class="flow-root">
                            <ul class="-mb-8">
                                <!-- Created -->
                                <li class="relative pb-8">
                                    <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200"></span>
                                    <div class="relative flex items-start space-x-3">
                                        <div>
                                            <span class="h-9 w-9 rounded-full bg-green-500 flex items-center justify-center ring-8 ring-white">
                                                <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">Payment Record Created</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    {{ payment.created_at|date:"F d, Y at g:i A" }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                
                                {% if payment.instructions_sent_at %}
                                <li class="relative pb-8">
                                    <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200"></span>
                                    <div class="relative flex items-start space-x-3">
                                        <div>
                                            <span class="h-9 w-9 rounded-full bg-blue-500 flex items-center justify-center ring-8 ring-white">
                                                <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">Payment Instructions Sent</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    {{ payment.instructions_sent_at|date:"F d, Y at g:i A" }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                                
                                {% if payment.payment_initiated_at %}
                                <li class="relative pb-8">
                                    <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200"></span>
                                    <div class="relative flex items-start space-x-3">
                                        <div>
                                            <span class="h-9 w-9 rounded-full bg-indigo-500 flex items-center justify-center ring-8 ring-white">
                                                <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">Payment Initiated by Enterprise</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    {{ payment.payment_initiated_at|date:"F d, Y at g:i A" }}
                                                </p>
                                                {% if payment.wire_transfer_date %}
                                                    <p class="mt-1 text-sm text-gray-600">
                                                        Wire Transfer Date: {{ payment.wire_transfer_date|date:"F d, Y" }}
                                                    </p>
                                                {% endif %}
                                                {% if payment.wire_transfer_confirmation %}
                                                    <p class="mt-1 text-sm text-gray-600">
                                                        Confirmation: {{ payment.wire_transfer_confirmation }}
                                                    </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                                
                                {% if payment.received_at %}
                                <li class="relative pb-8">
                                    <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200"></span>
                                    <div class="relative flex items-start space-x-3">
                                        <div>
                                            <span class="h-9 w-9 rounded-full bg-green-500 flex items-center justify-center ring-8 ring-white">
                                                <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">Payment Received</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    {{ payment.received_at|date:"F d, Y at g:i A" }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                                
                                {% if payment.released_at %}
                                <li class="relative">
                                    <div class="relative flex items-start space-x-3">
                                        <div>
                                            <span class="h-9 w-9 rounded-full bg-purple-500 flex items-center justify-center ring-8 ring-white">
                                                <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">Payment Released to Startup</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    {{ payment.released_at|date:"F d, Y at g:i A" }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Logs -->
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <h2 class="text-xl font-bold text-gray-800">Audit Log</h2>
                    </div>
                    
                    <div class="overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Date
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Action
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        User
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Notes
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for log in payment.logs.all|slice:":10" %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ log.created_at|date:"M d, Y g:i A" }}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900">
                                        {% if log.previous_status %}
                                            <span class="text-gray-500">{{ log.previous_status }}</span> → 
                                            <span class="font-medium">{{ log.new_status }}</span>
                                        {% else %}
                                            Created as <span class="font-medium">{{ log.new_status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ log.changed_by.get_full_name|default:log.changed_by.username|default:"System" }}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">
                                        {{ log.notes|default:"-" }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                        No logs found
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Admin Actions -->
                {% if payment.status == 'received' and payment.pilot_bid.status == 'approval_pending' %}
                <div class="mb-6 bg-blue-50 border-blue-200 rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-blue-100 border-b border-blue-200">
                        <h3 class="text-lg font-bold text-blue-800">Kick Off Pilot</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-blue-700 mb-4">
                            Payment has been received and verified. You can now kick off this pilot, which will notify both parties that work can begin.
                        </p>
                        <form method="post" action="{% url 'payments:admin_kickoff_pilot' payment.id %}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                Kick Off Pilot
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
                
                {% if payment.status == 'payment_initiated' %}
                <div class="mb-6 bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-yellow-50 border-b border-yellow-100">
                        <h3 class="text-lg font-bold text-yellow-800">Action Required</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-gray-600 mb-4">
                            The enterprise has marked this payment as sent. Please verify receipt in your bank account.
                        </p>
                        
                        <form method="post" action="{% url 'payments:admin_mark_payment_received' payment.id %}">
                            {% csrf_token %}
                            <div class="mb-4">
                                <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Admin Notes (Optional)
                                </label>
                                <textarea name="notes" 
                                          id="notes" 
                                          rows="3" 
                                          class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                          placeholder="Add any relevant details..."></textarea>
                            </div>
                            <button type="submit"
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                Confirm Payment Received
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
                
                {% if payment.status == 'received' %}
                <div class="mb-6 bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-green-50 border-b border-green-100">
                        <h3 class="text-lg font-bold text-green-800">Release Payment</h3>
                    </div>
                    <div class="p-6">
                        {% if payment.pilot_bid.status == 'completed' %}
                            <div class="mb-4 bg-green-50 border border-green-200 rounded-lg p-3">
                                <p class="text-sm text-green-700">
                                    <svg class="inline-block h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Pilot marked as completed
                                </p>
                                <p class="text-xs text-green-600 mt-1">
                                    {{ payment.pilot_bid.completed_at|date:"F d, Y" }}
                                </p>
                            </div>
                        {% else %}
                            <div class="mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p class="text-sm text-yellow-700">
                                    <svg class="inline-block h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    Pilot not marked as completed yet
                                </p>
                            </div>
                        {% endif %}
                        
                        <form method="post" action="{% url 'payments:admin_release_payment' payment.id %}">
                            {% csrf_token %}
                            <div class="mb-4">
                                <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Release Notes (Optional)
                                </label>
                                <textarea name="notes" 
                                          id="notes" 
                                          rows="3" 
                                          class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                          placeholder="Add any relevant details..."></textarea>
                            </div>
                            <button type="submit"
                                    {% if payment.pilot_bid.status != 'completed' %}disabled{% endif %}
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white {% if payment.pilot_bid.status == 'completed' %}bg-purple-600 hover:bg-purple-700{% else %}bg-gray-400 cursor-not-allowed{% endif %}">
                                Release Payment to Startup
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
                
                <!-- Admin Notes -->
                {% if payment.admin_notes %}
                <div class="mb-6 bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <h3 class="text-lg font-bold text-gray-800">Admin Notes</h3>
                    </div>
                    <div class="p-6">
                        <div class="prose text-sm text-gray-600">
                            {{ payment.admin_notes|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Manual Status Update -->
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <h3 class="text-lg font-bold text-gray-800">Manual Status Update</h3>
                    </div>
                    <div class="p-6">
                        <form method="post" action="{% url 'payments:admin_update_payment_status' payment.id %}">
                            {% csrf_token %}
                            <div class="mb-4">
                                <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                                    New Status
                                </label>
                                <select name="status" 
                                        id="status" 
                                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                    <option value="">Select status...</option>
                                    {% for status_value, status_label in payment.STATUS_CHOICES %}
                                        <option value="{{ status_value }}" {% if status_value == payment.status %}disabled{% endif %}>
                                            {{ status_label }} {% if status_value == payment.status %}(Current){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="manual_notes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Reason for Change
                                </label>
                                <textarea name="notes" 
                                          id="manual_notes" 
                                          rows="3" 
                                          required
                                          class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                          placeholder="Please provide a reason for this manual status change..."></textarea>
                            </div>
                            
                            <button type="submit"
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                Update Status
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}